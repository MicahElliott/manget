#! /bin/zsh

mgver=20251003

sect=1
destdir=~/.local/share/man/man$sect
host='https://github.com'
host='https://raw.githubusercontent.com'

if   [[ -z $1 ]]
then print 'USAGE: manget owner/proj [exename]'; exit
fi

if [[ $1 = '--version' ]]; then print "manget v$mgver"; exit ; fi

repo=$1 # 'walles/moor'

# TODO maybe use gh cli to fetch these
if [[ -n $2 ]]; then exe=$2; else exe=$1:t; fi # 'moor'
# cmdname=$3 # 'Moor Pager'
# reldate='XXX' # FIXME get from gh maybe, but unreliable and may not match up

print "Determining $exe version"
ver=$($exe --version | head -1)
org="${repo:h}Ê¼s $ver"

print 'Determining default branch'
mainbranch=$(curl -s "https://api.github.com/repos/$repo" |jq -r '.default_branch')

# https://raw.githubusercontent.com/walles/moor/refs/heads/master/README.md
readme=$host/$repo/refs/heads/$mainbranch/README.md
destfile=$destdir/$exe.$sect.gz

# eget $repo

print "Fetching $readme to $destfile"
# curl $readme | ronn --section $sect -r --name $cmdname --manual 'FIXME Manual Name' --pipe

# TODO Upcase H2s
# TODO Remove <code>
# TODO Remove Installation section

# Alternative to ronn:
# or use https://github.com/bmoneill/md2roff (golang)
# or https://github.com/cpuguy83/go-md2man

curl --silent $readme |
  ronn --section $sect -r --name $exe --manual 'External User Commands' --organization $org --pipe |
  gzip > $destfile
